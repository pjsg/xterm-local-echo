function t(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,e(t,r)}function r(t){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function e(t,r){return(e=Object.setPrototypeOf||function(t,r){return t.__proto__=r,t})(t,r)}function i(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function n(t,r,s){return(n=i()?Reflect.construct:function(t,r,i){var n=[null];n.push.apply(n,r);var s=new(Function.bind.apply(t,n));return i&&e(s,i.prototype),s}).apply(null,arguments)}function s(t){var i="function"==typeof Map?new Map:void 0;return(s=function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(t))return i.get(t);i.set(t,s)}function s(){return n(t,arguments,r(this).constructor)}return s.prototype=Object.create(t.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),e(s,t)})(t)}function o(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,i=new Array(r);e<r;e++)i[e]=t[e];return i}function a(t){var r=(void 0===t?{}:t).onlyFirst,e=void 0!==r&&r,i=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|");return new RegExp(i,e?void 0:"g")}for(var u=function(){function t(t){this.size=void 0,this.entries=[],this.cursor=0,this.size=t}var r=t.prototype;return r.push=function(t){""!==t.trim()&&(t!==this.entries[this.entries.length-1]?(this.entries.push(t),this.entries.length>this.size&&this.entries.shift(),this.cursor=this.entries.length):this.cursor=this.entries.length)},r.rewind=function(){this.cursor=this.entries.length},r.getPrevious=function(){var t=Math.max(0,this.cursor-1);return this.cursor=t,this.entries[t]},r.getNext=function(){var t=Math.min(this.entries.length,this.cursor+1);return this.cursor=t,this.entries[t]},t}(),h="(?:"+["\\|\\|","\\&\\&",";;","\\|\\&","\\<\\(",">>",">\\&","[&;()|<>]"].join("|")+")",l="",c=0;c<4;c++)l+=(Math.pow(16,8)*Math.random()).toString(16);var p=function(t,r,e){var i=function(t,r,e){var i=new RegExp(["("+h+")","((\\\\['\"|&;()<> \\t]|[^\\s'\"|&;()<> \\t])+|\"((\\\\\"|[^\"])*?)\"|'((\\\\'|[^'])*?)')*"].join("|"),"g"),n=t.match(i).filter(Boolean),s=!1;return n?(r||(r={}),e||(e={}),n.map(function(t,i){if(!s){if(RegExp("^"+h+"$").test(t))return{op:t};for(var o=e.escape||"\\",a=!1,u=!1,c="",p=!1,f=0,m=t.length;f<m;f++){var v=t.charAt(f);if(p=p||!a&&("*"===v||"?"===v),u)c+=v,u=!1;else if(a)v===a?a=!1:c+="'"==a?v:v===o?'"'===(v=t.charAt(f+=1))||v===o||"$"===v?v:o+v:"$"===v?d():v;else if('"'===v||"'"===v)a=v;else{if(RegExp("^"+h+"$").test(v))return{op:t};if(RegExp("^#$").test(v))return s=!0,c.length?[c,{comment:t.slice(f+1)+n.slice(i+1).join(" ")}]:[{comment:t.slice(f+1)+n.slice(i+1).join(" ")}];v===o?u=!0:c+="$"===v?d():v}}return p?{op:"glob",pattern:c}:c}function d(){var e,i;if("{"===t.charAt(f+=1)){if("}"===t.charAt(f+=1))throw new Error("Bad substitution: "+t.substr(f-2,3));if((e=t.indexOf("}",f))<0)throw new Error("Bad substitution: "+t.substr(f));i=t.substr(f,e-f),f=e}else/[*@#?$!_\-]/.test(t.charAt(f))?(i=t.charAt(f),f+=1):(e=t.substr(f).match(/[^\w\d_]/))?(i=t.substr(f,e.index),f+=e.index-1):(i=t.substr(f),f=t.length);return function(t,e,i){var n="function"==typeof r?r(i):r[i];return void 0===n&&""!=i?n="":void 0===n&&(n="$"),"object"==typeof n?""+l+JSON.stringify(n)+l:""+n}(0,0,i)}}).reduce(function(t,r){return void 0===r?t:t.concat(r)},[])):[]}(t,r,e);return"function"!=typeof r?i:i.reduce(function(t,r){if("object"==typeof r)return t.concat(r);var e=r.split(RegExp("("+l+".*?"+l+")","g"));return t.concat(1===e.length?e[0]:e.filter(Boolean).map(function(t){return RegExp("^"+l).test(t)?JSON.parse(t.split(l)[1]):t}))},[])},f=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531]],m=[[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]],v=new Uint8Array(65536);v.fill(1),v[0]=0,v.fill(0,1,32),v.fill(0,127,160),v.fill(2,4352,4448),v[9001]=2,v[9002]=2,v.fill(2,11904,42192),v[12351]=1,v.fill(2,44032,55204),v.fill(2,63744,64256),v.fill(2,65040,65050),v.fill(2,65072,65136),v.fill(2,65280,65377),v.fill(2,65504,65511);for(var d=0;d<f.length;++d)v.fill(0,f[d][0],f[d][1]+1);function g(t,r){var e;void 0===r&&(r=!0);for(var i=[],n=/\w+/g;e=n.exec(t);)i.push(r?e.index:e.index+e[0].length);return i}function y(t,r){var e=g(t,!0).reverse().find(function(t){return t<r});return null==e?0:e}function b(t,r,e){for(var i=0,n=0,s=0;s<r;++s)("\n"===t.charAt(s)||(n+=1)===e)&&(n=0,i+=1);return{row:i,col:n}}function w(t){for(var r,e="",i=0,n=function(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return o(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?o(t,r):void 0}}(t))){e&&(t=e);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t);!(r=n()).done;){var s=r.value;if("\t"===s){var a=8-i%8;e+=" ".repeat(a),i+=a}else e+=s,i+=1,"\n"===s&&(i=0)}return e}function P(t,r){return b(t,t.replace(a(),"").length,r).row+1}function C(t){return null!=t.match(/[^\\][ \t]$/m)}function A(t){return""===t.trim()||C(t)?"":p(t).pop()||""}function I(t,r){if(t.length>=r[0].length)return t;var e=t;t+=r[0].slice(t.length,t.length+1);for(var i=0;i<r.length;i++){if(!r[i].startsWith(e))return null;if(!r[i].startsWith(t))return e}return I(t,r)}var E=function(r){function e(t){var e,i,n,s,o;return(o=r.call(this)||this).history=void 0,o.terminal=void 0,o.disposables=[],o.enableAutocomplete=void 0,o.maxAutocompleteEntries=void 0,o.enableIncompleteInput=void 0,o.autocompleteHandlers=[],o.active=!1,o.input="",o.cursor=0,o.activePrompt=null,o.activeCharPrompt=null,o.writingPromise=null,o.remainKeys="",o.terminalSize={cols:0,rows:0},o.toSingleWidth=function(t){return function(t,r){for(var e,i="",n=0,s=0;s<t.length;++s){var o=(e=t.charCodeAt(s))<32?0:e<127?1:e<65536?v[e]:function(t,r){var e,i=0,n=r.length-1;if(t<r[0][0]||t>r[n][1])return!1;for(;n>=i;)if(t>r[e=i+n>>1][1])i=e+1;else{if(!(t<r[e][0]))return!0;n=e-1}return!1}(e,m)?0:e>=131072&&e<=196605||e>=196608&&e<=262141?2:1;0!==o?(2===o?n+o>r?(i+=" ",n+=1,s--):(i+=t[s],i+=" ",n+=o):(i+=t[s],n+=o),n===r&&(n=0)):"\n"===t[s]&&(n=0)}return i}(w(t),o.terminal.cols)},o.history=new u(null!=(e=null==t?void 0:t.historySize)?e:10),o.enableAutocomplete=null==(i=null==t?void 0:t.enableAutocomplete)||i,o.maxAutocompleteEntries=null!=(n=null==t?void 0:t.maxAutocompleteEntries)?n:100,o.enableIncompleteInput=null==(s=null==t?void 0:t.enableIncompleteInput)||s,o}t(e,r);var i=e.prototype;return i.activate=function(t){this.terminal=t,this.attach()},i.dispose=function(){this.detach()},i.addAutocompleteHandler=function(t){this.autocompleteHandlers.push({fn:t,args:[].slice.call(arguments,1)})},i.removeAutocompleteHandler=function(t){var r=this.autocompleteHandlers.findIndex(function(r){return r.fn===t});-1!==r&&this.autocompleteHandlers.splice(r,1)},i.read=function(t,r){void 0===r&&(r="> ");try{var e=this;return Promise.resolve(e.writingPromise).then(function(){return new Promise(function(i,n){void 0===t?(e.terminal.select(0,e.terminal.buffer.active.cursorY,e.terminal.buffer.active.cursorX),t=e.terminal.getSelection(),e.terminal.clearSelection()):e.terminal.write(t),e.activePrompt={prompt:t,continuationPrompt:r,resolve:i,reject:n},e.input="",e.cursor=0,e.active=!0,e.remainKeys.length>0&&e.handleTermData(e.remainKeys)})})}catch(t){return Promise.reject(t)}},i.readChar=function(t){var r=this;return new Promise(function(e,i){r.terminal.write(t),r.activeCharPrompt={prompt:t,resolve:e,reject:i}})},i.abortRead=function(t){void 0===t&&(t="aborted"),null==this.activePrompt&&null==this.activeCharPrompt||this.terminal.write("\r\n"),null!=this.activePrompt&&(this.activePrompt.reject(t),this.activePrompt=null),null!=this.activeCharPrompt&&(this.activeCharPrompt.reject(t),this.activeCharPrompt=null),this.active=!1},i.println=function(t){try{return Promise.resolve(this.print(t+"\n"))}catch(t){return Promise.reject(t)}},i.print=function(t){try{var r=this,e=t.replace(/[\r\n]?/g,"\n");return r.writingPromise=r.internalWrite(e.replace(/\n/g,"\r\n")),Promise.resolve(r.writingPromise)}catch(t){return Promise.reject(t)}},i.printWide=function(t,r){if(void 0===r&&(r=2),0==t.length)return this.println("");for(var e=t.reduce(function(t,r){return Math.max(t,r.length)},0)+r,i=Math.floor(this.terminalSize.cols/e),n=Math.ceil(t.length/i),s=0,o=0;o<n;++o){for(var a="",u=0;u<i;++u)if(s<t.length){var h=t[s++];a+=h+=" ".repeat(e-h.length)}this.println(a)}},i.attach=function(){var t=this;this.terminal&&(this.disposables.push(this.terminal.onData(function(r){return t.handleTermData(r)})),this.disposables.push(this.terminal.onResize(function(r){return t.handleTermResize(r)})),this.terminalSize={cols:this.terminal.cols,rows:this.terminal.rows})},i.detach=function(){this.disposables.forEach(function(t){return t.dispose()}),this.disposables=[]},i.internalWrite=function(t){try{var r=this;return Promise.resolve(new Promise(function(e){r.terminal.write(t,e)}))}catch(t){return Promise.reject(t)}},i.applyPrompts=function(t){return((this.activePrompt||{}).prompt||"")+t.replace(/\n/g,"\n"+((this.activePrompt||{}).continuationPrompt||""))},i.applyPromptOffset=function(t,r){var e=this.applyPrompts(t.substring(0,r));return(e=this.toSingleWidth(e)).replace(a(),"").length},i.clearInput=function(){for(var t=this.toSingleWidth(this.applyPrompts(this.input)),r=P(t,this.terminalSize.cols),e=r-b(t,this.applyPromptOffset(this.input,this.cursor),this.terminalSize.cols).row-1,i=e;i<0;++i)this.terminal.write("[2K[F");for(var n=0;n<e;++n)this.terminal.write("[E");this.terminal.write("\r[K");for(var s=1;s<r;++s)this.terminal.write("[F[K")},i.setInput=function(t,r){void 0===r&&(r=!0),r&&this.clearInput();var e=w(this.applyPrompts(t));this.print(e),e=this.toSingleWidth(e),this.cursor>t.length&&(this.cursor=t.length);var i=this.applyPromptOffset(t,this.cursor),n=P(e,this.terminalSize.cols),s=b(e,i,this.terminalSize.cols),o=s.col,a=s.row,u=n-a-1;0!==a&&0===o&&this.terminal.write("[E"),this.terminal.write("\r");for(var h=0;h<u;++h)this.terminal.write("[F");for(var l=0;l<o;++l)this.terminal.write("[C");this.input=t},i.printAndRestartPrompt=function(t){var r=this,e=this.cursor;this.setCursor(this.input.length),this.terminal.write("\r\n");var i=function(){r.cursor=e,r.setInput(r.input)},n=t();null==n?i():n.then(i)},i.setCursor=function(t){t<0&&(t=0),t>this.input.length&&(t=this.input.length);var r=this.applyPrompts(this.input),e=b(r,this.applyPromptOffset(this.input,this.cursor),this.terminalSize.cols),i=e.col,n=e.row,s=b(r,this.applyPromptOffset(this.input,t),this.terminalSize.cols),o=s.col,a=s.row;if(a>n)for(var u=n;u<a;++u)this.terminal.write("[B");else for(var h=a;h<n;++h)this.terminal.write("[A");if(o>i)for(var l=i;l<o;++l)this.terminal.write("[C");else for(var c=o;c<i;++c)this.terminal.write("[D");this.cursor=t},i.handleCursorMove=function(t){if(t>0){var r=Math.min(t,this.input.length-this.cursor);this.setCursor(this.cursor+r)}else if(t<0){var e=Math.max(t,-this.cursor);this.setCursor(this.cursor+e)}},i.handleCursorErase=function(t){if(t){if(this.cursor<=0)return;var r=this.input.substring(0,this.cursor-1)+this.input.substring(this.cursor);this.clearInput(),this.cursor-=1,this.setInput(r,!1)}else{var e=this.input.substring(0,this.cursor)+this.input.substring(this.cursor+1);this.setInput(e)}},i.handleCursorInsert=function(t){var r=this.input.substring(0,this.cursor)+t+this.input.substring(this.cursor);this.cursor+=t.length,this.setInput(r)},i.handleReadComplete=function(){try{var t=this;return t.history&&t.history.push(t.input),Promise.resolve(t.internalWrite("\r\n")).then(function(){t.activePrompt&&(t.activePrompt.resolve(t.input),t.activePrompt=null),t.active=!1})}catch(t){return Promise.reject(t)}},i.handleTermResize=function(t){var r=t.rows,e=t.cols;this.clearInput(),this.terminalSize={cols:e,rows:r},this.setInput(this.input,!1)},i.handleTermData=function(t){if(this.active&&0!==t.length){if(null!=this.activeCharPrompt)return this.activeCharPrompt.resolve(t),this.activeCharPrompt=null,void this.terminal.write("\r\n");if(t.length>3&&27!==t.charCodeAt(0)){for(var r=0;r<t.length;r++)if(this.handleData(t[r]),"\r"===t[r]){this.remainKeys=t.substring(r+1);break}}else this.handleData(t),this.remainKeys=""}},i.handleData=function(t){var r=this;if(this.active){var e,i,n,s,o=t.charCodeAt(0);if(27==o)switch(t.substring(1)){case"[A":if(this.history){var a=this.history.getPrevious();a&&(this.setInput(a),this.setCursor(a.length))}break;case"[B":if(this.history){var u=this.history.getNext();u||(u=""),this.setInput(u),this.setCursor(u.length)}break;case"[D":this.handleCursorMove(-1);break;case"[C":this.handleCursorMove(1);break;case"[3~":this.handleCursorErase(!1);break;case"[F":this.setCursor(this.input.length);break;case"[H":this.setCursor(0);break;case"b":null!=(e=y(this.input,this.cursor))&&this.setCursor(e);break;case"f":n=this.cursor,null!=(e=null==(s=g(i=this.input,!1).find(function(t){return t>n}))?i.length:s)&&this.setCursor(e);break;case"":null!=(e=y(this.input,this.cursor))&&(this.setInput(this.input.substring(0,e)+this.input.substring(this.cursor)),this.setCursor(e))}else if(o<32||127===o)switch(t){case"\r":this.enableIncompleteInput&&function(t){var r;return""!=t.trim()&&((t.match(/'/g)||[]).length%2!=0||(t.match(/"/g)||[]).length%2!=0||""==(null==(r=t.split(/(\|\||\||&&)/g).pop())?void 0:r.trim())||!(!t.endsWith("\\")||t.endsWith("\\\\")))}(this.input)?this.handleCursorInsert("\n"):this.handleReadComplete();break;case"":this.handleCursorErase(!0);break;case"\t":if(this.enableAutocomplete){if(this.autocompleteHandlers.length>0){var h=this.input.substring(0,this.cursor),l=C(h),c=function(t,r){var e=p(r),i=e.length-1,n=e[i]||"";return""===r.trim()?(i=0,n=""):C(r)&&(i+=1,n=""),t.reduce(function(t,r){var n=r.fn,s=r.args;try{return t.concat(n.apply(void 0,[i,e].concat(s)))}catch(r){return console.error("Auto-complete error:",r),t}},[]).filter(function(t){return t.startsWith(n)})}(this.autocompleteHandlers,h);if(c.sort(),0===c.length)l||this.handleCursorInsert(" ");else if(1===c.length){var f=A(h);this.handleCursorInsert(c[0].substring(f.length)+" ")}else if(c.length<=this.maxAutocompleteEntries){var m=I(h,c);if(m){var v=A(h);this.handleCursorInsert(m.substring(v.length))}this.printAndRestartPrompt(function(){r.printWide(c)})}else this.printAndRestartPrompt(function(){return r.readChar("Display all "+c.length+" possibilities? (y or n)").then(function(t){"y"!=t&&"Y"!=t||r.printWide(c)})})}}else this.handleCursorInsert("\t");break;case"":this.setCursor(this.input.length),this.terminal.write("^C\r\n"+((this.activePrompt||{}).prompt||"")),this.input="",this.cursor=0,this.history&&this.history.rewind(),this.emitInterrupt();break;case"":this.setCursor(this.input.length),this.terminal.write("^D\r\n"+((this.activePrompt||{}).prompt||"")),this.input="",this.cursor=0,this.history&&this.history.rewind(),this.abortRead(),this.emitEof()}else this.handleCursorInsert(t)}},e}(function(r){function e(){return r.apply(this,arguments)||this}t(e,r);var i=e.prototype;return i.emitEof=function(){this.dispatchEvent(new Event("eof"))},i.emitInterrupt=function(){this.dispatchEvent(new Event("interrupt"))},i.onEof=function(t){this.addEventListener("eof",t)},i.onInterrupt=function(t){this.addEventListener("interrupt",t)},e}(s(EventTarget)));export{E as LocalEchoAddon};
//# sourceMappingURL=index.module.js.map
