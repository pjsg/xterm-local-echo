function t({onlyFirst:t=!1}={}){const i=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|");return new RegExp(i,t?void 0:"g")}class i{constructor(t){this.size=void 0,this.entries=[],this.cursor=0,this.size=t}push(t){""!==t.trim()&&(t!==this.entries[this.entries.length-1]?(this.entries.push(t),this.entries.length>this.size&&this.entries.shift(),this.cursor=this.entries.length):this.cursor=this.entries.length)}rewind(){this.cursor=this.entries.length}getPrevious(){const t=Math.max(0,this.cursor-1);return this.cursor=t,this.entries[t]}getNext(){const t=Math.min(this.entries.length,this.cursor+1);return this.cursor=t,this.entries[t]}}for(var e="(?:"+["\\|\\|","\\&\\&",";;","\\|\\&","\\<\\(",">>",">\\&","[&;()|<>]"].join("|")+")",s="",r=0;r<4;r++)s+=(Math.pow(16,8)*Math.random()).toString(16);var n=function(t,i,r){var n=function(t,i,r){var n=new RegExp(["("+e+")","((\\\\['\"|&;()<> \\t]|[^\\s'\"|&;()<> \\t])+|\"((\\\\\"|[^\"])*?)\"|'((\\\\'|[^'])*?)')*"].join("|"),"g"),h=t.match(n).filter(Boolean),o=!1;return h?(i||(i={}),r||(r={}),h.map(function(t,n){if(!o){if(RegExp("^"+e+"$").test(t))return{op:t};for(var l=r.escape||"\\",a=!1,u=!1,c="",p=!1,m=0,f=t.length;m<f;m++){var d=t.charAt(m);if(p=p||!a&&("*"===d||"?"===d),u)c+=d,u=!1;else if(a)d===a?a=!1:c+="'"==a?d:d===l?'"'===(d=t.charAt(m+=1))||d===l||"$"===d?d:l+d:"$"===d?g():d;else if('"'===d||"'"===d)a=d;else{if(RegExp("^"+e+"$").test(d))return{op:t};if(RegExp("^#$").test(d))return o=!0,c.length?[c,{comment:t.slice(m+1)+h.slice(n+1).join(" ")}]:[{comment:t.slice(m+1)+h.slice(n+1).join(" ")}];d===l?u=!0:c+="$"===d?g():d}}return p?{op:"glob",pattern:c}:c}function g(){var e,r,n,h;if("{"===t.charAt(m+=1)){if("}"===t.charAt(m+=1))throw new Error("Bad substitution: "+t.substr(m-2,3));if((e=t.indexOf("}",m))<0)throw new Error("Bad substitution: "+t.substr(m));r=t.substr(m,e-m),m=e}else/[*@#?$!_\-]/.test(t.charAt(m))?(r=t.charAt(m),m+=1):(e=t.substr(m).match(/[^\w\d_]/))?(r=t.substr(m,e.index),m+=e.index-1):(r=t.substr(m),m=t.length);return n=r,void 0===(h="function"==typeof i?i(n):i[n])&&""!=n?h="":void 0===h&&(h="$"),"object"==typeof h?""+s+JSON.stringify(h)+s:""+h}}).reduce(function(t,i){return void 0===i?t:t.concat(i)},[])):[]}(t,i,r);return"function"!=typeof i?n:n.reduce(function(t,i){if("object"==typeof i)return t.concat(i);var e=i.split(RegExp("("+s+".*?"+s+")","g"));return t.concat(1===e.length?e[0]:e.filter(Boolean).map(function(t){return RegExp("^"+s).test(t)?JSON.parse(t.split(s)[1]):t}))},[])};const h=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531]],o=[[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]];let l=new Uint8Array(65536);l.fill(1),l[0]=0,l.fill(0,1,32),l.fill(0,127,160),l.fill(2,4352,4448),l[9001]=2,l[9002]=2,l.fill(2,11904,42192),l[12351]=1,l.fill(2,44032,55204),l.fill(2,63744,64256),l.fill(2,65040,65050),l.fill(2,65072,65136),l.fill(2,65280,65377),l.fill(2,65504,65511);for(let t=0;t<h.length;++t)l.fill(0,h[t][0],h[t][1]+1);function a(t,i=!0){let e;const s=[],r=/\w+/g;for(;e=r.exec(t);)s.push(i?e.index:e.index+e[0].length);return s}function u(t,i){const e=a(t,!0).reverse().find(t=>t<i);return null==e?0:e}function c(t,i,e){let s=0,r=0;for(let n=0;n<i;++n)"\n"===t.charAt(n)?(r=0,s+=1):(r+=1,r===e&&(r=0,s+=1));return{row:s,col:r}}function p(t){let i="",e=0;for(const s of t)if("\t"===s){const t=8-e%8;i+=" ".repeat(t),e+=t}else i+=s,e+=1,"\n"===s&&(e=0);return i}function m(i,e){return c(i,i.replace(t(),"").length,e).row+1}function f(t){return null!=t.match(/[^\\][ \t]$/m)}function d(t){return""===t.trim()||f(t)?"":n(t).pop()||""}function g(t,i){if(t.length>=i[0].length)return t;const e=t;t+=i[0].slice(t.length,t.length+1);for(let s=0;s<i.length;s++){if(!i[s].startsWith(e))return null;if(!i[s].startsWith(t))return e}return g(t,i)}class v extends EventTarget{emitEof(){this.dispatchEvent(new Event("eof"))}emitInterrupt(){this.dispatchEvent(new Event("interrupt"))}onEof(t){this.addEventListener("eof",t)}onInterrupt(t){this.addEventListener("interrupt",t)}}class b extends v{constructor(t){var e,s,r,n;super(),this.history=void 0,this.terminal=void 0,this.disposables=[],this.enableAutocomplete=void 0,this.maxAutocompleteEntries=void 0,this.enableIncompleteInput=void 0,this.autocompleteHandlers=[],this.active=!1,this.input="",this.cursor=0,this.activePrompt=null,this.activeCharPrompt=null,this.writingPromise=null,this.remainKeys="",this.terminalSize={cols:0,rows:0},this.toSingleWidth=t=>function(t,i){let e="",s=0;for(let n=0;n<t.length;++n){const h=(r=t.charCodeAt(n))<32?0:r<127?1:r<65536?l[r]:function(t,i){let e,s=0,r=i.length-1;if(t<i[0][0]||t>i[r][1])return!1;for(;r>=s;)if(e=s+r>>1,t>i[e][1])s=e+1;else{if(!(t<i[e][0]))return!0;r=e-1}return!1}(r,o)?0:r>=131072&&r<=196605||r>=196608&&r<=262141?2:1;0!==h?(2===h?s+h>i?(e+=" ",s+=1,n--):(e+=t[n],e+=" ",s+=h):(e+=t[n],s+=h),s===i&&(s=0)):"\n"===t[n]&&(s=0)}var r;return e}(p(t),this.terminal.cols),this.history=new i(null!=(e=null==t?void 0:t.historySize)?e:10),this.enableAutocomplete=null==(s=null==t?void 0:t.enableAutocomplete)||s,this.maxAutocompleteEntries=null!=(r=null==t?void 0:t.maxAutocompleteEntries)?r:100,this.enableIncompleteInput=null==(n=null==t?void 0:t.enableIncompleteInput)||n}activate(t){this.terminal=t,this.attach()}dispose(){this.detach()}addAutocompleteHandler(t,...i){this.autocompleteHandlers.push({fn:t,args:i})}removeAutocompleteHandler(t){const i=this.autocompleteHandlers.findIndex(i=>i.fn===t);-1!==i&&this.autocompleteHandlers.splice(i,1)}async read(t,i="> "){return await this.writingPromise,new Promise((e,s)=>{void 0===t?(this.terminal.select(0,this.terminal.buffer.active.cursorY,this.terminal.buffer.active.cursorX),t=this.terminal.getSelection(),this.terminal.clearSelection()):this.terminal.write(t),this.activePrompt={prompt:t,continuationPrompt:i,resolve:e,reject:s},this.input="",this.cursor=0,this.active=!0,this.remainKeys.length>0&&this.handleTermData(this.remainKeys)})}readChar(t){return new Promise((i,e)=>{this.terminal.write(t),this.activeCharPrompt={prompt:t,resolve:i,reject:e}})}abortRead(t="aborted"){null==this.activePrompt&&null==this.activeCharPrompt||this.terminal.write("\r\n"),null!=this.activePrompt&&(this.activePrompt.reject(t),this.activePrompt=null),null!=this.activeCharPrompt&&(this.activeCharPrompt.reject(t),this.activeCharPrompt=null),this.active=!1}async println(t){return this.print(t+"\n")}async print(t){const i=t.replace(/[\r\n]+/g,"\n");return this.writingPromise=this.internalWrite(i.replace(/\n/g,"\r\n")),this.writingPromise}printWide(t,i=2){if(0==t.length)return this.println("");const e=t.reduce((t,i)=>Math.max(t,i.length),0)+i,s=Math.floor(this.terminalSize.cols/e),r=Math.ceil(t.length/s);let n=0;for(let i=0;i<r;++i){let i="";for(let r=0;r<s;++r)if(n<t.length){let s=t[n++];s+=" ".repeat(e-s.length),i+=s}this.println(i)}}attach(){this.terminal&&(this.disposables.push(this.terminal.onData(t=>this.handleTermData(t))),this.disposables.push(this.terminal.onResize(t=>this.handleTermResize(t))),this.terminalSize={cols:this.terminal.cols,rows:this.terminal.rows})}detach(){this.disposables.forEach(t=>t.dispose()),this.disposables=[]}async internalWrite(t){return new Promise(i=>{this.terminal.write(t,i)})}applyPrompts(t){return((this.activePrompt||{}).prompt||"")+t.replace(/\n/g,"\n"+((this.activePrompt||{}).continuationPrompt||""))}applyPromptOffset(i,e){let s=this.applyPrompts(i.substring(0,e));return s=this.toSingleWidth(s),s.replace(t(),"").length}clearInput(){const t=this.toSingleWidth(this.applyPrompts(this.input)),i=m(t,this.terminalSize.cols),e=this.applyPromptOffset(this.input,this.cursor),{row:s}=c(t,e,this.terminalSize.cols),r=i-s-1;for(let t=r;t<0;++t)this.terminal.write("[2K[F");for(let t=0;t<r;++t)this.terminal.write("[E");this.terminal.write("\r[K");for(let t=1;t<i;++t)this.terminal.write("[F[K")}setInput(t,i=!0){i&&this.clearInput();let e=p(this.applyPrompts(t));this.print(e),e=this.toSingleWidth(e),this.cursor>t.length&&(this.cursor=t.length);const s=this.applyPromptOffset(t,this.cursor),r=m(e,this.terminalSize.cols),{col:n,row:h}=c(e,s,this.terminalSize.cols),o=r-h-1;0!==h&&0===n&&this.terminal.write("[E"),this.terminal.write("\r");for(let t=0;t<o;++t)this.terminal.write("[F");for(let t=0;t<n;++t)this.terminal.write("[C");this.input=t}printAndRestartPrompt(t){const i=this.cursor;this.setCursor(this.input.length),this.terminal.write("\r\n");const e=()=>{this.cursor=i,this.setInput(this.input)},s=t();null==s?e():s.then(e)}setCursor(t){t<0&&(t=0),t>this.input.length&&(t=this.input.length);const i=this.applyPrompts(this.input),e=this.applyPromptOffset(this.input,this.cursor),{col:s,row:r}=c(i,e,this.terminalSize.cols),n=this.applyPromptOffset(this.input,t),{col:h,row:o}=c(i,n,this.terminalSize.cols);if(o>r)for(let t=r;t<o;++t)this.terminal.write("[B");else for(let t=o;t<r;++t)this.terminal.write("[A");if(h>s)for(let t=s;t<h;++t)this.terminal.write("[C");else for(let t=h;t<s;++t)this.terminal.write("[D");this.cursor=t}handleCursorMove(t){if(t>0){const i=Math.min(t,this.input.length-this.cursor);this.setCursor(this.cursor+i)}else if(t<0){const i=Math.max(t,-this.cursor);this.setCursor(this.cursor+i)}}handleCursorErase(t){if(t){if(this.cursor<=0)return;const t=this.input.substring(0,this.cursor-1)+this.input.substring(this.cursor);this.clearInput(),this.cursor-=1,this.setInput(t,!1)}else{const t=this.input.substring(0,this.cursor)+this.input.substring(this.cursor+1);this.setInput(t)}}handleCursorInsert(t){const i=this.input.substring(0,this.cursor)+t+this.input.substring(this.cursor);this.cursor+=t.length,this.setInput(i)}async handleReadComplete(){this.history&&this.history.push(this.input),await this.internalWrite("\r\n"),this.activePrompt&&(this.activePrompt.resolve(this.input),this.activePrompt=null),this.active=!1}handleTermResize(t){const{rows:i,cols:e}=t;this.clearInput(),this.terminalSize={cols:e,rows:i},this.setInput(this.input,!1)}handleTermData(t){if(this.active&&0!==t.length){if(null!=this.activeCharPrompt)return this.activeCharPrompt.resolve(t),this.activeCharPrompt=null,void this.terminal.write("\r\n");if(t.length>3&&27!==t.charCodeAt(0)){for(let i=0;i<t.length;i++)if(this.handleData(t[i]),"\r"===t[i]){this.remainKeys=t.substring(i+1);break}}else this.handleData(t),this.remainKeys=""}}handleData(t){if(!this.active)return;const i=t.charCodeAt(0);let e;if(27==i)switch(t.substring(1)){case"[A":if(this.history){const t=this.history.getPrevious();t&&(this.setInput(t),this.setCursor(t.length))}break;case"[B":if(this.history){let t=this.history.getNext();t||(t=""),this.setInput(t),this.setCursor(t.length)}break;case"[D":this.handleCursorMove(-1);break;case"[C":this.handleCursorMove(1);break;case"[3~":this.handleCursorErase(!1);break;case"[F":this.setCursor(this.input.length);break;case"[H":this.setCursor(0);break;case"b":e=u(this.input,this.cursor),null!=e&&this.setCursor(e);break;case"f":e=function(t,i){const e=a(t,!1).find(t=>t>i);return null==e?t.length:e}(this.input,this.cursor),null!=e&&this.setCursor(e);break;case"":e=u(this.input,this.cursor),null!=e&&(this.setInput(this.input.substring(0,e)+this.input.substring(this.cursor)),this.setCursor(e))}else if(i<32||127===i)switch(t){case"\r":this.enableIncompleteInput&&""!=(s=this.input).trim()&&((s.match(/'/g)||[]).length%2!=0||(s.match(/"/g)||[]).length%2!=0||""==(null==(r=s.split(/(\|\||\||&&)/g).pop())?void 0:r.trim())||s.endsWith("\\")&&!s.endsWith("\\\\"))?this.handleCursorInsert("\n"):this.handleReadComplete();break;case"":this.handleCursorErase(!0);break;case"\t":if(this.enableAutocomplete){if(this.autocompleteHandlers.length>0){const t=this.input.substring(0,this.cursor),i=f(t),e=function(t,i){const e=n(i);let s=e.length-1,r=e[s]||"";return""===i.trim()?(s=0,r=""):f(i)&&(s+=1,r=""),t.reduce((t,{fn:i,args:r})=>{try{return t.concat(i(s,e,...r))}catch(i){return console.error("Auto-complete error:",i),t}},[]).filter(t=>t.startsWith(r))}(this.autocompleteHandlers,t);if(e.sort(),0===e.length)i||this.handleCursorInsert(" ");else if(1===e.length){const i=d(t);this.handleCursorInsert(e[0].substring(i.length)+" ")}else if(e.length<=this.maxAutocompleteEntries){const i=g(t,e);if(i){const e=d(t);this.handleCursorInsert(i.substring(e.length))}this.printAndRestartPrompt(()=>{this.printWide(e)})}else this.printAndRestartPrompt(()=>this.readChar(`Display all ${e.length} possibilities? (y or n)`).then(t=>{"y"!=t&&"Y"!=t||this.printWide(e)}))}}else this.handleCursorInsert("\t");break;case"":this.setCursor(this.input.length),this.terminal.write("^C\r\n"+((this.activePrompt||{}).prompt||"")),this.input="",this.cursor=0,this.history&&this.history.rewind(),this.emitInterrupt();break;case"":this.setCursor(this.input.length),this.terminal.write("^D\r\n"+((this.activePrompt||{}).prompt||"")),this.input="",this.cursor=0,this.history&&this.history.rewind(),this.abortRead(),this.emitEof()}else this.handleCursorInsert(t);var s,r}}export{b as LocalEchoAddon};
//# sourceMappingURL=index.modern.js.map
